<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Calendário Areia Ana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #050814;
      --card: #0b1020;
      --card-soft: #101629;
      --accent: #ff7a1a;
      --accent-soft: #ff9b4a;
      --text: #f5f7ff;
      --text-soft: #c2c7ff;
      --danger: #ff4c4c;
      --border: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151821 0, #050814 45%, #02030a 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }

    .wrapper {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(145deg, #060a18, #02030a);
      border-radius: 24px;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.7);
      padding: 32px 28px 28px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .header p {
      font-size: 13px;
      color: var(--text-soft);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 20px;
      margin-top: 20px;
    }

    @media (max-width: 720px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    input[type="password"],
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      background: #050814;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input[type="password"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 122, 26, 0.5);
    }

    input[type="color"] {
      width: 100%;
      height: 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050814;
      padding: 2px 8px;
      cursor: pointer;
    }

    .full {
      grid-column: 1 / -1;
    }

    .hint {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
      line-height: 1.45;
    }

    .btn-primary {
      width: 100%;
      border: none;
      margin-top: 8px;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(120deg, var(--accent), var(--accent-soft));
      color: #050814;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      box-shadow: 0 10px 26px rgba(255, 122, 26, 0.4);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .msg {
      margin-top: 10px;
      font-size: 13px;
    }

    .msg.ok {
      color: #56fba7;
    }

    .msg.err {
      color: var(--danger);
    }

    .lista-wrapper {
      margin-top: 28px;
      padding-top: 18px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .lista-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .lista-header h2 {
      font-size: 15px;
    }

    .lista-header small {
      font-size: 11px;
      color: var(--text-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #070b17;
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    th {
      font-weight: 500;
      color: var(--text-soft);
      font-size: 12px;
    }

    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.01);
    }

    .tag-cor {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .bolinha {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.4);
    }

    .btn-del {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(255, 76, 76, 0.1);
      color: var(--danger);
      cursor: pointer;
    }

    .empty {
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
      padding: 10px 0 0;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <h1>Admin – Calendário</h1>
      <p>
        Somente quem tem a senha consegue incluir eventos. As atualizações aparecem automaticamente para os usuários.
      </p>
    </div>

    <form id="formEvento">
      <div class="grid">
        <div class="full">
          <label for="senha">Senha de administrador:</label>
          <input type="password" id="senha" placeholder="Digite a senha" required />
        </div>

        <div class="full">
          <label for="titulo">Título do evento:</label>
          <input type="text" id="titulo" placeholder="Ex.: Reunião de Alinhamento" required />
        </div>

        <div>
          <label for="dataReferencia">Data de referência do evento:</label>
          <!-- AQUI ESTÁ O INPUT COM CALENDÁRIO -->
          <input type="date" id="dataReferencia" required />
          <div class="hint">
            Use a data inicial. Para recorrências semanais/mensais, os demais dias serão gerados automaticamente.
          </div>
        </div>

        <div>
          <label for="repeticao">Tipo de recorrência:</label>
          <select id="repeticao">
            <option value="unico">Evento único</option>
            <option value="semanal">Toda semana (mesmo dia da semana)</option>
            <option value="mensal">Todo mês (mesmo dia do mês)</option>
          </select>
          <div class="hint">
            Ex.: "Todo dia 20" → selecione mensal. "Toda segunda" → selecione semanal.
          </div>
        </div>

        <div>
          <label for="dataFim">Repetir até (opcional):</label>
          <input type="date" id="dataFim" />
          <div class="hint">
            Se vazio: gera recorrência somente dentro do mesmo ano da data de referência.
          </div>
        </div>

        <div>
          <label for="cor">Cor do evento:</label>
          <input type="color" id="cor" value="#ff7a1a" />
          <div class="hint">
            Use uma cor padrão por tipo de evento (reunião, treinamento, campanha etc.).
            Feriados já aparecem em cinza automaticamente.
          </div>
        </div>

        <div class="full">
          <button type="submit" class="btn-primary">Incluir evento(s)</button>
          <div id="msg" class="msg"></div>
        </div>
      </div>
    </form>

    <div class="lista-wrapper">
      <div class="lista-header">
        <h2>Eventos cadastrados</h2>
        <small>Os mais recentes aparecem primeiro. Exclusão é imediata.</small>
      </div>
      <div id="listaEventosContainer"></div>
    </div>
  </div>

  <script>
    // ========= CONFIGURAÇÕES =========
    const SENHA_ADMIN = "areia2025";
    const BASE_URL =
      "https://agenda-areia-ana-default-rtdb.firebaseio.com"; // ajuste se mudar o projeto

    const form = document.getElementById("formEvento");
    const msgEl = document.getElementById("msg");
    const listaEventosContainer = document.getElementById("listaEventosContainer");

    // ========= UTILITÁRIOS =========
    function mostrarMsg(texto, tipo = "ok") {
      msgEl.textContent = texto;
      msgEl.className = "msg " + (tipo === "ok" ? "ok" : "err");
    }

    function limparMsg() {
      msgEl.textContent = "";
      msgEl.className = "msg";
    }

    function formatarDataBR(iso) {
      const [ano, mes, dia] = iso.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function parseISO(dataStr) {
      // dataStr no formato yyyy-mm-dd
      const [y, m, d] = dataStr.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function toISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    // Gera um array de datas ISO (yyyy-mm-dd) conforme recorrência
    function gerarDatas(dataRefISO, dataFimISO, tipoRepeticao) {
      const datas = [];

      let atual = parseISO(dataRefISO);

      let limite;
      if (dataFimISO) {
        limite = parseISO(dataFimISO);
      } else {
        // se não tiver data fim → até o final do ano da data de referência
        limite = new Date(atual.getFullYear(), 11, 31); // 31/12
      }

      if (tipoRepeticao === "unico") {
        datas.push(dataRefISO);
        return datas;
      }

      if (tipoRepeticao === "semanal") {
        while (atual <= limite) {
          datas.push(toISO(atual));
          atual.setDate(atual.getDate() + 7);
        }
        return datas;
      }

      if (tipoRepeticao === "mensal") {
        const dia = atual.getDate();
        while (atual <= limite) {
          datas.push(toISO(atual));

          const mes = atual.getMonth();
          const ano = atual.getFullYear();
          const proximo = new Date(ano, mes + 1, 1);
          const ultimoDiaProxMes = new Date(ano, mes + 2, 0).getDate();

          proximo.setDate(Math.min(dia, ultimoDiaProxMes));
          atual = proximo;
        }
        return datas;
      }

      // fallback
      datas.push(dataRefISO);
      return datas;
    }

    // ========= FIREBASE =========
    async function carregarEventos() {
      try {
        const resp = await fetch(`${BASE_URL}/eventos.json`);
        const data = await resp.json();

        if (!data) {
          listaEventosContainer.innerHTML =
            '<div class="empty">Nenhum evento cadastrado ainda.</div>';
          return;
        }

        const lista = Object.entries(data).map(([id, ev]) => ({
          id,
          ...ev,
        }));

        lista.sort((a, b) => (a.data < b.data ? 1 : -1)); // mais recentes primeiro

        let html = `
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Título</th>
                <th>Cor</th>
                <th style="text-align:right;">Ações</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const ev of lista) {
          html += `
            <tr>
              <td>${ev.data ? formatarDataBR(ev.data) : "-"}</td>
              <td>${ev.titulo || ""}</td>
              <td>
                <span class="tag-cor">
                  <span class="bolinha" style="background:${ev.cor || "#ff7a1a"}"></span>
                  ${ev.cor || ""}
                </span>
              </td>
              <td style="text-align:right;">
                <button type="button" class="btn-del" onclick="excluirEvento('${ev.id}')">
                  Excluir
                </button>
              </td>
            </tr>
          `;
        }

        html += "</tbody></table>";
        listaEventosContainer.innerHTML = html;
      } catch (e) {
        console.error(e);
        listaEventosContainer.innerHTML =
          '<div class="empty">Erro ao carregar eventos.</div>';
      }
    }

    async function excluirEvento(id) {
      if (!confirm("Tem certeza que deseja excluir este evento?")) return;
      try {
        await fetch(`${BASE_URL}/eventos/${id}.json`, {
          method: "DELETE",
        });
        await carregarEventos();
      } catch (e) {
        console.error(e);
        alert("Erro ao excluir evento. Tente novamente.");
      }
    }

    window.excluirEvento = excluirEvento; // deixa disponível no HTML

    // ========= SUBMIT FORM =========
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      limparMsg();

      const senha = document.getElementById("senha").value.trim();
      if (senha !== SENHA_ADMIN) {
        mostrarMsg("Senha incorreta.", "err");
        return;
      }

      const titulo = document.getElementById("titulo").value.trim();
      const dataRef = document.getElementById("dataReferencia").value;
      const tipoRep = document.getElementById("repeticao").value;
      const dataFim = document.getElementById("dataFim").value || null;
      const cor = document.getElementById("cor").value || "#ff7a1a";

      if (!titulo || !dataRef) {
        mostrarMsg("Preencha pelo menos o título e a data de referência.", "err");
        return;
      }

      const datasGeradas = gerarDatas(dataRef, dataFim, tipoRep);
      if (!datasGeradas.length) {
        mostrarMsg("Nenhuma data gerada. Verifique os campos.", "err");
        return;
      }

      try {
        for (const dataISO of datasGeradas) {
          const novoEv = {
            data: dataISO,
            titulo,
            cor,
            criadoEm: new Date().toISOString(),
          };

          await fetch(`${BASE_URL}/eventos.json`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(novoEv),
          });
        }

        mostrarMsg(
          `Evento salvo com sucesso em ${datasGeradas.length} data(s).`,
          "ok"
        );
        form.reset();
        document.getElementById("cor").value = "#ff7a1a";
        await carregarEventos();
      } catch (err) {
        console.error(err);
        mostrarMsg("Erro ao salvar eventos. Tente novamente.", "err");
      }
    });

    // Carregar lista inicial
    carregarEventos();
  </script>
</body>
</html>
